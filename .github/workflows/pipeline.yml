name: Optimized CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_ENV: ${{ secrets.NODE_ENV }}
  PORT: ${{ secrets.PORT }}
  HOST: ${{ secrets.HOST }}
  CORS_ORIGIN: ${{ secrets.CORS_ORIGIN }}
  COMMON_RATE_LIMIT_WINDOW_MS: ${{ secrets.COMMON_RATE_LIMIT_WINDOW_MS }}
  COMMON_RATE_LIMIT_MAX_REQUESTS: ${{ secrets.COMMON_RATE_LIMIT_MAX_REQUESTS }}
  CLUSTER_ENABLED: ${{ secrets.CLUSTER_ENABLED }}
  AZURE_OPENAI_API_VERSION: ${{ secrets.AZURE_OPENAI_API_VERSION }}
  AZURE_OPENAI_API_INSTANCE_NAME: ${{ secrets.AZURE_OPENAI_API_INSTANCE_NAME }}
  AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
  AZURE_OPENAI_API_DEPLOYMENT_NAME: ${{ secrets.AZURE_OPENAI_API_DEPLOYMENT_NAME }}
  AZURE_OPENAI_API_EMBEDDINGS_DEPLOYMENT_NAME: ${{ secrets.AZURE_OPENAI_API_EMBEDDINGS_DEPLOYMENT_NAME }}

jobs:
  setup:
    uses: ./.github/workflows/setup.yml

  lint:
    uses: ./.github/workflows/lint.yml
    needs: setup

  test:
    uses: ./.github/workflows/test.yml
    needs: setup

  build:
    uses: ./.github/workflows/build.yml
    needs: setup